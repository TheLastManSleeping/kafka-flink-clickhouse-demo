services:
  kafka:
    image: 'bitnami/kafka:latest'
    container_name: kafka
    ports:
      - "29092:9092"
    volumes:
      - kafka_data:/bitnami/kafka
      - ./kafka-entrypoint.sh:/entrypoint-custom.sh
    entrypoint: /entrypoint-custom.sh
    environment:
      - KAFKA_CFG_NODE_ID=1
      - KAFKA_CFG_PROCESS_ROLES=broker,controller
      - KAFKA_CFG_CONTROLLER_LISTENER_NAMES=CONTROLLER
      - KAFKA_CFG_LISTENERS=PLAINTEXT://:9092,CONTROLLER://:9093
      - KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT://kafka:9092
      - KAFKA_CFG_CONTROLLER_QUORUM_VOTERS=1@kafka:9093
      - KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP=CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
      - ALLOW_PLAINTEXT_LISTENER=yes
      # --- –ü–∞—Ä–∞ –ø—Ä–∏–º–µ—Ä–æ–≤ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –¥–ª—è Kafka ---
      # –ö–û–õ–ò–ß–ï–°–¢–í–û –ü–ê–†–¢–ò–¶–ò–ô.
      # –ë–æ–ª—å—à–µ –ø–∞—Ä—Ç–∏—Ü–∏–π –ø–æ–∑–≤–æ–ª—è—é—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –±–æ–ª–µ–µ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ.
      # - KAFKA_CFG_NUM_PARTITIONS=3

      # –í–†–ï–ú–Ø –•–†–ê–ù–ï–ù–ò–Ø –°–û–û–ë–©–ï–ù–ò–ô
      # –ö–∞–∫ –¥–æ–ª–≥–æ —Ö—Ä–∞–Ω–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —Ç–æ–ø–∏–∫–µ –¥–æ –∏—Ö —É–¥–∞–ª–µ–Ω–∏—è.
      # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é - 7 –¥–Ω–µ–π (604800000 –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥). -1 –æ–∑–Ω–∞—á–∞–µ—Ç "—Ö—Ä–∞–Ω–∏—Ç—å –≤–µ—á–Ω–æ".
      # –ü—Ä–∏–º–µ—Ä: 1 —á–∞—Å (3600000)
      # - KAFKA_CFG_LOG_RETENTION_MS=3600000

    healthcheck:
      test: ["CMD", "kafka-topics.sh", "--bootstrap-server", "localhost:9092", "--list"]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 10s

  clickhouse-server:
    image: clickhouse/clickhouse-server:latest
    container_name: clickhouse-server
    ports:
      - "8123:8123"
      - "9000:9000"
    volumes:
      - ./clickhouse_data:/var/lib/clickhouse/
      - ./clickhouse_init:/docker-entrypoint-initdb.d/


  jobmanager:
    build: ./flink 
    container_name: jobmanager
    ports:
      - "8081:8081"
    volumes:
      - ./flink/sql:/opt/flink/sql 
      - flink_checkpoints:/opt/flink/checkpoints 
    environment:
      - |
        FLINK_PROPERTIES=
        jobmanager.rpc.address: jobmanager
        # --- –ù–ê–°–¢–†–û–ô–ö–ò FLINK ---
        #
        # üöÄ –ü–ê–†–ê–õ–õ–ï–õ–ò–ó–ú
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –ø–æ—Ç–æ–∫–æ–≤ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞–Ω–∏—è.
        # –î–æ–ª–∂–Ω–æ –±—ã—Ç—å –º–µ–Ω—å—à–µ –∏–ª–∏ —Ä–∞–≤–Ω–æ –æ–±—â–µ–º—É –∫–æ–ª–∏—á–µ—Å—Ç–≤—É —Å–ª–æ—Ç–æ–≤ (scale * taskmanager.numberOfTaskSlots).
        # parallelism.default: 2
        #
        # üíæ –ß–ï–ö–ü–û–ò–ù–¢–ò–ù–ì (–¥–ª—è –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏)
        # –í–∫–ª—é—á–∞–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
        # execution.checkpointing.interval: 1min
        # state.backend: filesystem
        # state.checkpoints.dir: file:///opt/flink/checkpoints
    command: > 
      bash -c "
      /opt/flink/bin/jobmanager.sh start-foreground &
      JOBMANAGER_PID=$!;
      echo 'Waiting for Flink UI...';
      while ! timeout 1 bash -c 'true &>/dev/null </dev/tcp/localhost/8081'; do sleep 1; done;
      echo 'Flink UI is up. Waiting for Kafka...';
      while ! timeout 1 bash -c 'true &>/dev/null </dev/tcp/kafka/9092'; do sleep 1; done;
      echo 'Kafka is up. Submitting job...';
      /opt/flink/bin/sql-client.sh -f /opt/flink/sql/job.sql;
      wait $JOBMANAGER_PID;
      "

  taskmanager:
    build: ./flink  
    container_name: taskmanager
    depends_on:
      - jobmanager
    command: taskmanager 
    scale: 1
    volumes:
      - flink_checkpoints:/opt/flink/checkpoints 

    environment:
      - |
        FLINK_PROPERTIES=
        jobmanager.rpc.address: jobmanager
        taskmanager.numberOfTaskSlots: 4
        # --- –ù–ê–°–¢–†–û–ô–ö–ò FLINK (–û–ø–∏—Å–∞–Ω–∏–µ —Å–º–æ—Ç—Ä–µ—Ç—å –≤—ã—à–µ) ---
        #
        # üöÄ –ü–ê–†–ê–õ–õ–ï–õ–ò–ó–ú
        # parallelism.default: 2
        #
        # üíæ –ß–ï–ö–ü–û–ò–ù–¢–ò–ù–ì
        # execution.checkpointing.interval: 1min
        # state.backend: filesystem
        # state.checkpoints.dir: file:///opt/flink/checkpoints


  event-emitter:
    build: ./emitter
    container_name: event-emitter
    depends_on:
      - kafka
    environment:
      # –ó–¥–µ—Å—å –≤—ã –º–æ–∂–µ—Ç–µ –∑–∞–¥–∞—Ç—å –ª—é–±—É—é –∂–µ–ª–∞–µ–º—É—é —Å–∫–æ—Ä–æ—Å—Ç—å –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —Å–µ–∫—É–Ω–¥—É
      - MESSAGES_PER_SECOND=100
      
      # --- –ù–ê–°–¢–†–û–ô–ö–ò –ü–†–û–î–Æ–°–ï–†–ê ---
      # –£–†–û–í–ï–ù–¨ –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–Ø
      # –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∏.
      # '0': –Ω–µ –∂–¥–∞—Ç—å –æ—Ç–≤–µ—Ç–∞ (–º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å, –Ω–æ –µ—Å—Ç—å —Ä–∏—Å–∫ –ø–æ—Ç–µ—Ä–∏ —Å–æ–æ–±—â–µ–Ω–∏–π).
      # '1': –∂–¥–∞—Ç—å –æ—Ç–≤–µ—Ç–∞ —Ç–æ–ª—å–∫–æ –æ—Ç –ª–∏–¥–µ—Ä–∞ –ø–∞—Ä—Ç–∏—Ü–∏–∏ (—Ö–æ—Ä–æ—à–∏–π –±–∞–ª–∞–Ω—Å, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é).
      # 'all': –∂–¥–∞—Ç—å –æ—Ç–≤–µ—Ç–∞ –æ—Ç –≤—Å–µ—Ö —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ä–µ–ø–ª–∏–∫ (–º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å).
      # - PRODUCER_ACKS=1

      # –†–ê–ó–ú–ï–† –ü–ê–ß–ö–ò (–≤ –±–∞–π—Ç–∞—Ö)
      # –ü—Ä–æ–¥—é—Å–µ—Ä –≥—Ä—É–ø–ø–∏—Ä—É–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π.
      # –ë–æ–ª—å—à–∏–π —Ä–∞–∑–º–µ—Ä = –≤—ã—à–µ –ø—Ä–æ–ø—É—Å–∫–Ω–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å, –Ω–æ –≤—ã—à–µ –∏ –∑–∞–¥–µ—Ä–∂–∫–∞.
      # - PRODUCER_BATCH_SIZE=4096 # (—ç—Ç–æ 4 –ö–ë)

      # –í–†–ï–ú–Ø –û–ñ–ò–î–ê–ù–ò–Ø (–≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö)
      # –ö–∞–∫ –¥–æ–ª–≥–æ –∂–¥–∞—Ç—å, —á—Ç–æ–±—ã –Ω–∞–ø–æ–ª–Ω–∏—Ç—å –ø–∞—á–∫—É.
      # –ó–Ω–∞—á–µ–Ω–∏–µ > 0 —Å–∏–ª—å–Ω–æ —É–ª—É—á—à–∞–µ—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø—Ä–∏ –Ω–µ–ø–æ–ª–Ω–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ.
      # - PRODUCER_LINGER_MS=5

volumes:
  kafka_data:
  flink_checkpoints: